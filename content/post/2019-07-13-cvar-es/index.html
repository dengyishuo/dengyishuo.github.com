---
title: CVaR 和 ES 补充 VaR 的风险度量方法解析（含 R 包应用）
author: DengYishuo
date: '2025-07-13'
slug: cvar-es
categories:
  - econometrics
tags:
  - r
  - CVaR
---



<div id="理论基础概述" class="section level1">
<h1>理论基础概述</h1>
<p>在金融风险管理领域，风险价值（VaR）是一种广泛使用的风险度量工具，它衡量在一定置信水平下，某一金融资产或投资组合在未来特定时期内可能遭受的最大损失。然而，VaR 存在一些局限性，主要体现在以下几个方面：</p>
<p>缺乏次可加性：在某些情况下，投资组合的 VaR 可能大于其各组成部分 VaR 之和，这与分散投资降低风险的直觉相悖。对尾部风险的刻画不足：VaR 只关注损失分布的分位数点，而不考虑超过该点的损失程度。不满足一致性风险度量的要求：VaR 不满足一致性风险度量公理中的次可加性、正齐次性、单调性和平移不变性。为了克服 VaR 的这些局限性，条件风险价值（CVaR）和预期短缺（ES）作为更高级的风险度量方法被提出。CVaR 与 ES 的基本概念条件风险价值（Conditional Value at Risk, CVaR），也称为平均短缺（Average Shortfall, AS）或预期短缺（Expected Shortfall, ES），是指在给定置信水平下，超过 VaR 的损失的期望值。它不仅考虑了损失超过 VaR 的概率，还考虑了超过部分的大小，因此能更全面地反映尾部风险。数学公式解析VaR 的数学定义对于给定的投资组合收益率 R 和置信水平 <span class="math inline">\(\alpha\)</span>，VaR 可以定义为：<span class="math inline">\(\text{VaR}_\alpha = -\inf \{ x \in \mathbb{R} : F_R(x) \geq \alpha \}\)</span>其中，<span class="math inline">\(F_R(x)\)</span> 是收益率 R 的累积分布函数。在实际应用中，VaR 通常表示为：<span class="math inline">\(P(R \leq -\text{VaR}_\alpha) = 1 - \alpha\)</span>CVaR/ES 的数学定义CVaR/ES 在置信水平 <span class="math inline">\(\alpha\)</span> 下的定义为：<span class="math inline">\(\text{CVaR}_\alpha = \text{ES}_\alpha = \mathbb{E}[-R | R \leq -\text{VaR}_\alpha]\)</span>当收益率分布连续时，CVaR/ES 可以表示为：<span class="math inline">\(\text{ES}_\alpha = \frac{1}{1-\alpha} \int_{0}^{1-\alpha} \text{VaR}_p \, dp\)</span>这个公式表明，ES 是所有低于 <span class="math inline">\(\alpha\)</span> 置信水平的 VaR 的平均值。R 语言实现示例下面通过 R 语言实现基于纳斯达克数据的 VaR、CVaR 和 ES 计算，使用 quantmod 包获取数据，并对比不同 R 包的计算方法。使用 quantmod 获取数据r# 加载必要的包
library(quantmod)
library(PerformanceAnalytics)
library(xts)</p>
</div>
<div id="获取纳斯达克综合指数数据" class="section level1">
<h1>获取纳斯达克综合指数数据</h1>
<p>getSymbols(“^IXIC”, from = “2020-01-01”, to = Sys.Date())</p>
</div>
<div id="计算日对数收益率" class="section level1">
<h1>计算日对数收益率</h1>
<p>returns &lt;- diff(log(Cl(IXIC)))
returns &lt;- na.omit(returns)</p>
</div>
<div id="设置置信水平" class="section level1">
<h1>设置置信水平</h1>
<p>alpha &lt;- 0.95
使用不同 R 包计算 ES/CVaR1. PerformanceAnalytics 包r# 使用PerformanceAnalytics包计算ES
library(PerformanceAnalytics)</p>
<p>es_historical &lt;- ES(returns, p = alpha, method = “historical”)
es_gaussian &lt;- ES(returns, p = alpha, method = “gaussian”)</p>
<p>cat(“PerformanceAnalytics包计算结果:”)
cat(“历史模拟法 ES:”, round(es_historical * 100, 2), “%”)
cat(“正态分布假设 ES:”, round(es_gaussian * 100, 2), “%”)
2. RiskPortfolios 包r# 使用RiskPortfolios包计算ES
library(RiskPortfolios)</p>
<p>es_riskport &lt;- ES(returns, alpha = 1 - alpha)</p>
<p>cat(“:”)
cat(“ES:”, round(es_riskport * 100, 2), “%”)
3. fGarch 包r# 使用fGarch包计算ES
library(fGarch)</p>
<p>es_empirical &lt;- ES.empirical(returns, p = alpha)</p>
</div>
<div id="拟合garch模型并预测" class="section level1">
<h1>拟合GARCH模型并预测</h1>
<p>garch_model &lt;- garchFit(~garch(1,1), data = returns, trace = FALSE)
forecast &lt;- predict(garch_model, n.ahead = 1)
es_garch &lt;- ES.normal(mean = forecast<span class="math inline">\(meanForecast,
                      sd = forecast\)</span>standardDeviation,
p = alpha)</p>
<p>cat(“:”)
cat(“历史模拟法 ES:”, round(es_empirical * 100, 2), “%”)
cat(“GARCH模型预测 ES:”, round(es_garch * 100, 2), “%”)
4. ExpectedShortfall 包r# 使用ExpectedShortfall包计算ES
library(ExpectedShortfall)</p>
<p>es_exp_shortfall &lt;- ES_Hist(returns, alpha = 1 - alpha)</p>
<p>cat(“:”)
cat(“ES:”, round(es_exp_shortfall * 100, 2), “%”)
5. rugarch 包r# 使用rugarch包计算ES
library(rugarch)</p>
</div>
<div id="定义garch模型" class="section level1">
<h1>定义GARCH模型</h1>
<p>spec &lt;- ugarchspec(variance.model = list(model = “sGARCH”),
mean.model = list(armaOrder = c(0,0)))
fit &lt;- ugarchfit(spec, data = returns, solver = “hybrid”)</p>
</div>
<div id="计算es" class="section level1">
<h1>计算ES</h1>
<p>risk_metrics &lt;- riskmetrics(fit, n.ahead = 1, conf.level = alpha)
es_rugarch &lt;- risk_metrics$ES</p>
<p>cat(“:”)
cat(“GARCH模型 ES:”, round(es_rugarch * 100, 2), “%”)
结果对比与可视化r# 整合所有方法的ES结果
methods &lt;- c(“历史模拟法”, “正态分布”, “GARCH(fGarch)”, “历史模拟(ES包)”, “GARCH(rugarch)”)
es_results &lt;- c(es_historical, es_gaussian, es_garch, es_exp_shortfall, es_rugarch)</p>
</div>
<div id="创建结果数据框" class="section level1">
<h1>创建结果数据框</h1>
<p>results_df &lt;- data.frame(Method = methods, ES = es_results)</p>
</div>
<div id="可视化不同方法的es结果" class="section level1">
<h1>可视化不同方法的ES结果</h1>
<p>library(ggplot2)
ggplot(results_df, aes(x = Method, y = ES * 100, fill = Method)) +
geom_bar(stat = “identity”) +
theme_minimal() +
labs(title = “不同方法计算的ES对比”,
y = “ES (%)”,
x = “计算方法”) +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
geom_text(aes(label = round(ES * 100, 2)), vjust = -0.5)
结论CVaR 和 ES 作为 VaR 的补充工具，能够更全面地度量金融风险，尤其是在处理尾部风险时表现更为出色。通过结合使用 VaR、CVaR 和 ES，风险管理者可以获得更完整的风险图景，从而做出更明智的风险管理决策。在实际应用中，应根据投资组合的特性和市场环境选择合适的风险度量方法。不同 R 包提供了多种计算 ES/CVaR 的方法，各有特点：PerformanceAnalytics：简单易用，支持多种分布假设RiskPortfolios：专注投资组合风险分析fGarch/rugarch：适合结合 GARCH 模型处理时变波动率ExpectedShortfall：提供 ES 回测功能建议结合数据特性（如是否存在厚尾、波动聚类等）选择合适的模型，并对比不同方法的结果以确保对极端风险的充分考虑。</p>
</div>
