---
title: 全天候动量ETF策略
author: MatrixSpk
date: '2025-12-23'
slug: all-weather-momentum
categories:
  - investment
tags:
  - momentum
  - etf
---



<pre><code>## 正在从Yahoo Finance获取数据...</code></pre>
<pre><code>## [1] &quot;513100.SS&quot; &quot;510300.SS&quot; &quot;518880.SS&quot;</code></pre>
<pre class="r"><code># 2. 计算指标：动量、波动率、调整动量
calculate_metrics &lt;- function(price_series, window = 20) {
  # 计算日收益率
  returns &lt;- dailyReturn(price_series, type = &quot;arithmetic&quot;)
  colnames(returns) &lt;- &quot;Return&quot;
  
  # 计算20日平均收益率（动量）
  momentum &lt;- rollapply(returns, width = window, FUN = mean, align = &quot;right&quot;, fill = NA)
  colnames(momentum) &lt;- &quot;Momentum&quot;
  
  # 计算20日收益率方差（波动率）
  volatility &lt;- rollapply(returns, width = window, FUN = var, align = &quot;right&quot;, fill = NA)
  colnames(volatility) &lt;- &quot;Volatility&quot;
  
  # 计算调整动量（动量/波动率）
  # 注意：使用标准差进行标准化（方差的平方根）
  adj_momentum &lt;- momentum / sqrt(volatility)
  colnames(adj_momentum) &lt;- &quot;Adj_Momentum&quot;
  
  return(list(returns = returns, 
              momentum = momentum, 
              volatility = volatility, 
              adj_momentum = adj_momentum))
}

# 为每个ETF计算指标
# cat(&quot;正在计算动量指标...\n&quot;)
metrics_list &lt;- list()
for (etf in etf_names) {
  metrics_list[[etf]] &lt;- calculate_metrics(price_df[, etf])
}</code></pre>
<pre><code>## Warning in to_period(xx, period = on.opts[[period]], ...): missing values
## removed from data
## Warning in to_period(xx, period = on.opts[[period]], ...): missing values
## removed from data
## Warning in to_period(xx, period = on.opts[[period]], ...): missing values
## removed from data</code></pre>
<pre class="r"><code># 3. 生成交易信号和权重
generate_weights &lt;- function(adj_momentum_df) {
  # 初始化权重数据框
  weights_df &lt;- as.data.frame(adj_momentum_df)
  weights_df[] &lt;- 0  # 所有值初始化为0
  
  # 对每一行（每个交易日）计算权重
  for (i in 1:nrow(adj_momentum_df)) {
    # 获取当日的调整动量值
    current_momentum &lt;- as.numeric(adj_momentum_df[i, ])
    
    # 筛选调整动量大于0的标的
    positive_idx &lt;- which(current_momentum &gt; 0 &amp; !is.na(current_momentum))
    
    if (length(positive_idx) &gt; 0) {
      # 获取正的调整动量值
      positive_momentum &lt;- current_momentum[positive_idx]
      
      # 按调整动量大小归一化计算权重
      normalized_weights &lt;- positive_momentum / sum(positive_momentum)
      
      # 分配权重
      weights_df[i, positive_idx] &lt;- normalized_weights
    }
  }
  
  # 转换为时间序列
  weights_xts &lt;- xts(weights_df, order.by = index(adj_momentum_df))
  colnames(weights_xts) &lt;- colnames(adj_momentum_df)
  
  return(weights_xts)
}

# 提取所有ETF的调整动量
adj_momentum_all &lt;- do.call(merge, lapply(metrics_list, function(x) x$adj_momentum))
colnames(adj_momentum_all) &lt;- etf_names

# 生成权重序列
# cat(&quot;正在计算每日权重...\n&quot;)
weights &lt;- generate_weights(adj_momentum_all)

# 4. 将权重数据整理到数据框中
# 创建每日权重数据框（包含日期）
daily_weights_df &lt;- data.frame(Date = index(weights))
for (etf in etf_names) {
  daily_weights_df[[etf]] &lt;- as.numeric(weights[, etf])
}

# 计算每个交易日的权重合计（应为1或0）
daily_weights_df$权重合计 &lt;- rowSums(daily_weights_df[, etf_names], na.rm = TRUE)

# 创建每个ETF的单独权重数据框
etf_weight_dfs &lt;- list()
for (etf in etf_names) {
  etf_weight_dfs[[etf]] &lt;- data.frame(
    Date = index(weights),
    ETF = etf,
    Weight = as.numeric(weights[, etf])
  )
}

# 合并所有ETF权重数据框
all_etf_weights_df &lt;- do.call(rbind, etf_weight_dfs)

# 5. 回测计算
# 计算每个ETF的日收益率
returns_all &lt;- do.call(merge, lapply(metrics_list, function(x) x$returns))
colnames(returns_all) &lt;- etf_names

# 调整权重的时间索引，确保与收益率对齐
# 使用T日的权重在T+1日交易
lagged_weights &lt;- lag(weights, 1)  # 权重滞后一天
lagged_weights &lt;- lagged_weights[index(returns_all)]  # 对齐索引

# 处理缺失值
lagged_weights[is.na(lagged_weights)] &lt;- 0

# 计算策略日收益率（按T+1日开盘价计算，这里用平均价近似）
strategy_returns &lt;- rowSums(returns_all * lagged_weights, na.rm = TRUE)
strategy_returns &lt;- xts(strategy_returns, order.by = index(returns_all))
colnames(strategy_returns) &lt;- &quot;动量策略&quot;

# 6. 绩效指标计算
# cat(&quot;正在计算绩效指标...\n&quot;)
# 策略绩效
strategy_perf &lt;- table.AnnualizedReturns(strategy_returns)
strategy_dd &lt;- table.DownsideRisk(strategy_returns)
max_dd &lt;- maxDrawdown(strategy_returns)
strategy_calmar &lt;- CalmarRatio(strategy_returns)
strategy_sortino &lt;- SortinoRatio(strategy_returns)
strategy_positive_returns &lt;- sum(strategy_returns &gt; 0, na.rm = TRUE)
strategy_total_returns &lt;- sum(!is.na(strategy_returns))
strategy_win_rate &lt;- strategy_positive_returns / strategy_total_returns

# 基准绩效（沪深300ETF）
benchmark_returns &lt;- returns_all[, &quot;沪深300ETF&quot;]
colnames(benchmark_returns) &lt;- &quot;沪深300ETF&quot;
benchmark_perf &lt;- table.AnnualizedReturns(benchmark_returns)
benchmark_dd &lt;- table.DownsideRisk(benchmark_returns)
benchmark_max_dd &lt;- maxDrawdown(benchmark_returns)
benchmark_calmar &lt;- CalmarRatio(benchmark_returns)
benchmark_sortino &lt;- SortinoRatio(benchmark_returns)
benchmark_positive_returns &lt;- sum(benchmark_returns &gt; 0, na.rm = TRUE)
benchmark_total_returns &lt;- sum(!is.na(benchmark_returns))
benchmark_win_rate &lt;- benchmark_positive_returns / benchmark_total_returns

# 等权重组合绩效
equal_weights &lt;- matrix(1/3, nrow = nrow(returns_all), ncol = ncol(returns_all))
equal_weights &lt;- xts(equal_weights, order.by = index(returns_all))
colnames(equal_weights) &lt;- etf_names
equal_returns &lt;- rowSums(returns_all * equal_weights, na.rm = TRUE)
equal_returns &lt;- xts(equal_returns, order.by = index(returns_all))
colnames(equal_returns) &lt;- &quot;等权重组合&quot;
equal_perf &lt;- table.AnnualizedReturns(equal_returns)
equal_max_dd &lt;- maxDrawdown(equal_returns)
equal_calmar &lt;- CalmarRatio(equal_returns)
equal_sortino &lt;- SortinoRatio(equal_returns)
equal_positive_returns &lt;- sum(equal_returns &gt; 0, na.rm = TRUE)
equal_total_returns &lt;- sum(!is.na(equal_returns))
equal_win_rate &lt;- equal_positive_returns / equal_total_returns

# 7. 创建绩效指标汇总数据框
# 格式化日期字符串
start_date_str &lt;- format(start_date, &quot;%Y-%m-%d&quot;)
end_date_str &lt;- format(end_date, &quot;%Y-%m-%d&quot;)
period_str &lt;- paste(start_date_str, &quot;至&quot;, end_date_str)

performance_metrics_df &lt;- data.frame(
  策略 = c(&quot;动量策略&quot;, &quot;沪深300ETF&quot;, &quot;等权重组合&quot;),
  年化收益率 = c(
    round(strategy_perf[1, 1] * 100, 2),
    round(benchmark_perf[1, 1] * 100, 2),
    round(equal_perf[1, 1] * 100, 2)
  ),
  年化波动率 = c(
    round(strategy_perf[2, 1] * 100, 2),
    round(benchmark_perf[2, 1] * 100, 2),
    round(equal_perf[2, 1] * 100, 2)
  ),
  夏普比率 = c(
    round(strategy_perf[3, 1], 3),
    round(benchmark_perf[3, 1], 3),
    round(equal_perf[3, 1], 3)
  ),
  最大回撤 = c(
    round(max_dd * 100, 2),
    round(benchmark_max_dd * 100, 2),
    round(equal_max_dd * 100, 2)
  ),
  卡尔马比率 = c(
    round(strategy_calmar, 3),
    round(benchmark_calmar, 3),
    round(equal_calmar, 3)
  ),
  索提诺比率 = c(
    round(strategy_sortino, 3),
    round(benchmark_sortino, 3),
    round(equal_sortino, 3)
  ),
  胜率 = c(
    round(strategy_win_rate * 100, 2),
    round(benchmark_win_rate * 100, 2),
    round(equal_win_rate * 100, 2)
  ),
  正收益天数 = c(
    strategy_positive_returns,
    benchmark_positive_returns,
    equal_positive_returns
  ),
  总交易天数 = c(
    strategy_total_returns,
    benchmark_total_returns,
    equal_total_returns
  ),
  回测期间 = c(period_str, period_str, period_str)
)

# 8. 绩效指标输出
# cat(&quot;==================== 绩效指标汇总数据框 ====================\n\n&quot;)
print(performance_metrics_df)</code></pre>
<pre><code>##         策略 年化收益率 年化波动率 夏普比率 最大回撤 卡尔马比率 索提诺比率
## 1   动量策略      45.13      17.08    2.643     8.72      5.178      0.227
## 2 沪深300ETF      20.31      19.27    1.054    16.25      1.250      0.103
## 3 等权重组合      31.84      12.89    2.470     9.29      3.429      0.201
##    胜率 正收益天数 总交易天数                 回测期间
## 1 53.04        253        477 2024-01-01 至 2025-12-23
## 2 51.26        244        476 2024-01-01 至 2025-12-23
## 3 59.33        283        477 2024-01-01 至 2025-12-23</code></pre>
<pre class="r"><code># cat(&quot;\n&quot;)

# 9. 输出权重数据

# cat(&quot;每日组合权重数据框（后10行）:\n&quot;)
print(tail(daily_weights_df, 10))</code></pre>
<pre><code>##           Date    纳指ETF 沪深300ETF   黄金ETF 权重合计
## 468 2025-12-08 0.09379501 0.00000000 0.9062050        1
## 469 2025-12-09 0.00000000 0.00000000 0.0000000        0
## 470 2025-12-10 0.00000000 0.00000000 1.0000000        1
## 471 2025-12-11 0.00000000 0.00000000 0.0000000        0
## 472 2025-12-12 0.05889600 0.00000000 0.9411040        1
## 473 2025-12-15 0.00000000 0.00000000 1.0000000        1
## 474 2025-12-16 0.16844695 0.00000000 0.8315530        1
## 475 2025-12-17 0.31823928 0.01791372 0.6638470        1
## 476 2025-12-18 0.00000000 0.00000000 1.0000000        1
## 477 2025-12-19 0.22970999 0.26353990 0.5067501        1</code></pre>
<pre class="r"><code># cat(&quot;\n&quot;)


# 10. 绘制图表
# cat(&quot;正在生成图表...\n&quot;)
# 准备累计收益率数据
cumulative_returns &lt;- merge(
  cumprod(1 + na.fill(strategy_returns, 0)) - 1,
  cumprod(1 + na.fill(benchmark_returns, 0)) - 1,
  cumprod(1 + na.fill(equal_returns, 0)) - 1
)
colnames(cumulative_returns) &lt;- c(&quot;动量策略&quot;, &quot;沪深300ETF&quot;, &quot;等权重组合&quot;)

# 转换为数据框用于ggplot
cumulative_df &lt;- data.frame(
  Date = index(cumulative_returns),
  as.data.frame(cumulative_returns)
)
cumulative_long &lt;- pivot_longer(cumulative_df, 
                                cols = -Date, 
                                names_to = &quot;Portfolio&quot;, 
                                values_to = &quot;CumulativeReturn&quot;)

# 图表1：策略 vs 基准累计收益率和最大回撤对比
p1 &lt;- ggplot(cumulative_long %&gt;% filter(Portfolio %in% c(&quot;动量策略&quot;, &quot;沪深300ETF&quot;)), 
             aes(x = Date, y = CumulativeReturn, color = Portfolio)) +
  geom_line(size = 1.2) +
  labs(title = &quot;动量策略 vs 沪深300ETF: 累计收益率对比&quot;,
       x = &quot;日期&quot;, y = &quot;累计收益率&quot;) +
  scale_y_continuous(labels = percent_format()) +
  scale_color_manual(values = c(&quot;动量策略&quot; = &quot;blue&quot;, &quot;沪深300ETF&quot; = &quot;red&quot;)) +
  theme_minimal() +
  theme(legend.position = &quot;bottom&quot;,
        plot.title = element_text(hjust = 0.5, size = 14, face = &quot;bold&quot;))</code></pre>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.</code></pre>
<pre class="r"><code># 图表2：策略 vs 各ETF Buy &amp; Hold对比
# 计算各ETF的累计收益率
etf_cumulative &lt;- do.call(merge, 
                          lapply(1:length(etf_names), 
                                 function(i) cumprod(1 + na.fill(returns_all[, i], 0)) - 1))
colnames(etf_cumulative) &lt;- paste0(etf_names, &quot; (Buy&amp;Hold)&quot;)

all_cumulative &lt;- merge(cumulative_returns[, &quot;动量策略&quot;], etf_cumulative)
all_cumulative_df &lt;- data.frame(Date = index(all_cumulative), 
                                as.data.frame(all_cumulative))
all_cumulative_long &lt;- pivot_longer(all_cumulative_df, 
                                    cols = -Date, 
                                    names_to = &quot;Strategy&quot;, 
                                    values_to = &quot;CumulativeReturn&quot;)

p2 &lt;- ggplot(all_cumulative_long, aes(x = Date, y = CumulativeReturn, color = Strategy)) +
  geom_line(size = 1) +
  labs(title = &quot;动量策略 vs 各ETF买入持有策略: 累计收益率对比&quot;,
       x = &quot;日期&quot;, y = &quot;累计收益率&quot;) +
  scale_y_continuous(labels = percent_format()) +
  theme_minimal() +
  theme(legend.position = &quot;bottom&quot;,
        plot.title = element_text(hjust = 0.5, size = 14, face = &quot;bold&quot;))

# 图表3：策略 vs 等权重组合对比
p3 &lt;- ggplot(cumulative_long %&gt;% filter(Portfolio %in% c(&quot;动量策略&quot;, &quot;等权重组合&quot;)), 
             aes(x = Date, y = CumulativeReturn, color = Portfolio)) +
  geom_line(size = 1.2) +
  labs(title = &quot;动量策略 vs 等权重组合: 累计收益率对比&quot;,
       x = &quot;日期&quot;, y = &quot;累计收益率&quot;) +
  scale_y_continuous(labels = percent_format()) +
  scale_color_manual(values = c(&quot;动量策略&quot; = &quot;blue&quot;, &quot;等权重组合&quot; = &quot;green&quot;)) +
  theme_minimal() +
  theme(legend.position = &quot;bottom&quot;,
        plot.title = element_text(hjust = 0.5, size = 14, face = &quot;bold&quot;))

# 图表4：权重随时间变化图
# 准备权重数据
weights_long &lt;- pivot_longer(daily_weights_df, 
                             cols = all_of(etf_names),
                             names_to = &quot;ETF&quot;, 
                             values_to = &quot;Weight&quot;)

p4 &lt;- ggplot(weights_long, aes(x = Date, y = Weight, fill = ETF)) +
  geom_area(position = &quot;stack&quot;, alpha = 0.7) +
  labs(title = &quot;动量策略: 每日权重分配&quot;,
       x = &quot;日期&quot;, y = &quot;权重&quot;) +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_manual(values = c(&quot;纳指ETF&quot; = &quot;blue&quot;, 
                               &quot;沪深300ETF&quot; = &quot;red&quot;, 
                               &quot;黄金ETF&quot; = &quot;gold&quot;)) +
  theme_minimal() +
  theme(legend.position = &quot;bottom&quot;,
        plot.title = element_text(hjust = 0.5, size = 14, face = &quot;bold&quot;))</code></pre>
<pre class="r"><code># 12. 显示图表
# cat(&quot;\n正在显示图表...\n&quot;)
print(p1)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code># cat(&quot;\n\n&quot;)</code></pre>
<pre class="r"><code>print(p2)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code># cat(&quot;\n\n&quot;)</code></pre>
<pre class="r"><code>print(p3)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code># cat(&quot;\n\n&quot;)</code></pre>
<pre class="r"><code>print(p4)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
