---
title: 五分钟搞定 SMA 指标的量化策略开发和回测
author: MatrixSpk
date: '2025-05-25'
slug: sma
categories:
  - quant
tags:
  - sma
  - r
  - quantstrat
  - quantmod
---

```{R setup, message=TRUE, warning=TRUE, include = FALSE }
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
# 加载软件包
library(quantstrat)
library(Tushare)
library(xts)
library(dplyr)
library(showtext)
library(PerformanceAnalytics)
library(zoo)
library(tidyverse)
font_add("SimHei", regular = "SimHei.ttf")
showtext_auto()
```

常有人问我，能用几分钟时间上手写一段代码进行一个简易的量化投资策略的开发和回测吗？答案是当然可以。对于量化投资而言，门槛永远不是编程和代码，而是投资思路和模型解读。下面我们用五分钟左右的时间来开发一个基于 SMA 指标的量化投资策略并进行回测。
 
# 引言

本文的代码基于[R](https://r-project.org)软件和 [Rstuido](https://posit.co)  软件运行，如果未安装上述软件，请自行安装。

```{R pkg, eval = FALSE}
# 安装依赖包，如果未安装
install.packages(c("quantstrat", "Tushare", "xts", "dplyr", "showtext", "zoo","PerformanceAnalytics","tidyverse"))
# 加载软件包
library(quantstrat)
library(Tushare)
library(xts)
library(dplyr)
library(showtext)
library(PerformanceAnalytics)
library(zoo)
library(tidyverse)
```

# 清理环境

```{R rm}
# 清理.strategy环境中的对象
if (exists(".strategy", envir = globalenv())) {
    strategy_env <- get(".strategy", envir = globalenv())
    strategy_objects <- ls(strategy_env)
    for (obj in strategy_objects) {
        rm(list = obj, envir = strategy_env)
    }
}

# 清理.blotter环境中的对象
if (exists(".blotter", envir = globalenv())) {
    blotter_env <- get(".blotter", envir = globalenv())
    blotter_objects <- ls(blotter_env)
    for (obj in blotter_objects) {
        rm(list = obj, envir = blotter_env)
    }
}

# 清理.account环境中的对象
if (exists(".account", envir = globalenv())) {
    account_env <- get(".account", envir = globalenv())
    account_objects <- ls(account_env)
    for (obj in account_objects) {
        rm(list = obj, envir = account_env)
    }
}
```

# 策略开发


## 初始化设置

```{R init}
currency("RMB")  # 设置货币为人民币
stock("maotai", currency="RMB") # 设置贵州茅台股票代码
```

## 获取数据

使用quantmod获取贵州茅台数据

```{R dat}
getSymbols("600519.SS", from="2010-01-01", to=Sys.Date())
maotai <- `600519.SS` # 重命名对象
colnames(maotai) <- c("Open","High","Low","Close","Volume","Adjusted")
```

## 初始化策略

```{R creat_stra}
strategy.name <- "SMA_Strategy"
portfolio.name <- "maotai_portfolio"
account.name <- "maotai_account"

# 清除旧策略(如果存在)
rm.strat(strategy.name)

# 初始化组合、账户和策略
initPortf(portfolio.name, symbols="maotai", initDate="2009-12-31")
initAcct(account.name, portfolios=portfolio.name, initDate="2009-12-31", initEq=100000)
initOrders(portfolio.name, initDate="2009-12-31")
strategy(strategy.name, store=TRUE)
```

## 添加指标

这里添加的简单移动平均线(SMA)：

```{R add_indicator}
add.indicator(
  strategy = strategy.name,
  name = "SMA",  # 使用SMA指标
  arguments = list(x=quote(Cl(mktdata)), n=50), # 50日均线
  label = "SMA50"
)

add.indicator(
  strategy = strategy.name,
  name = "SMA",
  arguments = list(x=quote(Cl(mktdata)), n=200), # 200日均线
  label = "SMA200"
)
```

## 添加信号 - 金叉死叉

```{R add_signal}
add.signal(
  strategy.name,
  name = "sigCrossover",
  arguments = list(columns=c("SMA50","SMA200"), relationship="gt"), # 50日线上穿200日线
  label = "golden.cross"
)

add.signal(
  strategy.name,
  name = "sigCrossover",
  arguments = list(columns=c("SMA50","SMA200"), relationship="lt"), # 50日线下穿200日线
  label = "death.cross"
)
```


## 添加交易规则

```{R add_rule}
# 金叉买入规则
add.rule(
  strategy.name,
  name = "ruleSignal",
  arguments = list(
    sigcol = "golden.cross",
    sigval = TRUE,
    orderqty = 100,  # 买入100股
    ordertype = "market",
    orderside = "long",
    replace = FALSE
  ),
  type = "enter",
  label = "EnterLong"
)

# 死叉卖出规则
add.rule(
  strategy.name,
  name = "ruleSignal",
  arguments = list(
    sigcol = "death.cross",
    sigval = TRUE,
    orderqty = "all",  # 卖出全部持仓
    ordertype = "market",
    orderside = "long",
    replace = FALSE
  ),
  type = "exit",
  label = "ExitLong"
)
```

# 策略回测

```{R apply}
applyStrategy(
  strategy = strategy.name,
  portfolios = portfolio.name
)
```

# 更新组合和账户

```{R update}
updatePortf(portfolio.name)
updateAcct(account.name)
updateEndEq(account.name)
```

# 分析结果

```{R ana}
# 获取交易统计数据
tstats <- tradeStats(portfolio.name)
print(tstats)

# 绘制权益曲线
equity <- getAccount(account.name)$summary$End.Eq
plot(equity, main="Strategy Equity Curve")

# 绘制持仓和交易
chart.Posn(portfolio.name, Symbol="maotai", TA="add_SMA(n=50,col='blue');add_SMA(n=200,col='red')")
```
